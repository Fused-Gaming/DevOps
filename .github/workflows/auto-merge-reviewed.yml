name: Auto-Merge Reviewed PRs

# Automatically merge PRs when:
# 1. All checks pass
# 2. PR is approved
# 3. Has auto-generated label

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  pull_request:
    types:
      - ready_for_review
      - labeled

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-approve-and-merge:
    name: ðŸ”„ Auto-Approve & Merge
    runs-on: ubuntu-latest
    # Only run for PRs with auto-generated label
    if: |
      github.event.pull_request != null &&
      contains(github.event.pull_request.labels.*.name, 'auto-generated')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check PR Status
        id: pr_status
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "Checking PR #$PR_NUMBER status..."

          # Get PR details
          PR_DATA=$(gh pr view "$PR_NUMBER" --json isDraft,mergeable,reviewDecision,statusCheckRollup)

          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft')
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          REVIEW_DECISION=$(echo "$PR_DATA" | jq -r '.reviewDecision')

          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "review_decision=$REVIEW_DECISION" >> $GITHUB_OUTPUT

          echo "Status:"
          echo "  - Draft: $IS_DRAFT"
          echo "  - Mergeable: $MERGEABLE"
          echo "  - Review Decision: $REVIEW_DECISION"

          # Check if all checks passed
          CHECK_STATUS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup[].conclusion' | sort -u)
          FAILED_CHECKS=$(echo "$CHECK_STATUS" | grep -c "FAILURE" || echo 0)
          PENDING_CHECKS=$(echo "$CHECK_STATUS" | grep -c "PENDING" || echo 0)

          echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
          echo "pending_checks=$PENDING_CHECKS" >> $GITHUB_OUTPUT

          if [ "$FAILED_CHECKS" -gt 0 ]; then
            echo "âŒ Some checks failed"
            echo "can_merge=false" >> $GITHUB_OUTPUT
          elif [ "$PENDING_CHECKS" -gt 0 ]; then
            echo "â³ Checks still pending"
            echo "can_merge=false" >> $GITHUB_OUTPUT
          elif [ "$IS_DRAFT" == "true" ]; then
            echo "ðŸ“ PR is still a draft"
            echo "can_merge=false" >> $GITHUB_OUTPUT
          elif [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "âš ï¸ PR has conflicts or is not mergeable"
            echo "can_merge=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… All checks passed"
            echo "can_merge=true" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Auto-Approve PR
        if: |
          steps.pr_status.outputs.can_merge == 'true' &&
          steps.pr_status.outputs.review_decision != 'APPROVED'
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Approve the PR
          cat > /tmp/approve_body.md << 'APPROVE_EOF'
          ## âœ… Auto-Approval

          All checks have passed successfully!

          **Validation Results:**
          - âœ… All CI/CD checks passed
          - âœ… No merge conflicts
          - âœ… Branch is up to date
          - âœ… Ready for merge

          This PR will be automatically merged.

          ---
          *Auto-approved by auto-merge-reviewed workflow*
          APPROVE_EOF

          gh pr review "$PR_NUMBER" --approve --body-file /tmp/approve_body.md

          echo "âœ… PR #$PR_NUMBER auto-approved"

      - name: ðŸ”„ Enable Auto-Merge
        if: steps.pr_status.outputs.can_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Enable auto-merge with squash strategy
          gh pr merge "$PR_NUMBER" \
            --auto \
            --squash \
            --delete-branch \
            || echo "âš ï¸ Auto-merge may already be enabled or not available"

          echo "ðŸ”„ Auto-merge enabled for PR #$PR_NUMBER"

      - name: ðŸš€ Attempt Direct Merge
        if: |
          steps.pr_status.outputs.can_merge == 'true' &&
          steps.pr_status.outputs.review_decision == 'APPROVED'
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Try to merge directly
          gh pr merge "$PR_NUMBER" \
            --squash \
            --delete-branch \
            --admin \
            || echo "âš ï¸ Direct merge not available, auto-merge will handle it"

          echo "âœ“ Merge attempted for PR #$PR_NUMBER"

      - name: ðŸ“Š Post Status Comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          if [ "${{ steps.pr_status.outputs.can_merge }}" == "true" ]; then
            STATUS_MESSAGE=$(cat << 'MSG'
            ## âœ… Ready to Merge

            All conditions met for auto-merge:
            - âœ… All checks passed
            - âœ… No conflicts
            - âœ… PR approved
            - ðŸ”„ Auto-merge enabled

            The PR will merge automatically.
            MSG
            )
          elif [ "${{ steps.pr_status.outputs.pending_checks }}" -gt 0 ]; then
            STATUS_MESSAGE=$(cat << 'MSG'
            ## â³ Waiting for Checks

            Some checks are still running. Will auto-merge when:
            - All checks pass
            - No merge conflicts remain
            - PR is approved
            MSG
            )
          elif [ "${{ steps.pr_status.outputs.failed_checks }}" -gt 0 ]; then
            STATUS_MESSAGE=$(cat << 'MSG'
            ## âŒ Checks Failed

            Some CI/CD checks failed. Please review and fix:
            - Review failed check logs
            - Push fixes to this branch
            - Checks will re-run automatically
            MSG
            )
          elif [ "${{ steps.pr_status.outputs.is_draft }}" == "true" ]; then
            STATUS_MESSAGE=$(cat << 'MSG'
            ## ðŸ“ Draft PR

            This PR is still a draft. To enable auto-merge:
            1. Click 'Ready for review' button
            2. Wait for checks to complete
            3. PR will auto-approve and merge
            MSG
            )
          else
            STATUS_MESSAGE=$(cat << 'MSG'
            ## â„¹ï¸ Status Update

            PR status checked. Waiting for conditions to enable auto-merge.
            MSG
            )
          fi

          cat > /tmp/status_comment.md <<STATUS_EOF
          $STATUS_MESSAGE

          ---
          *Status checked at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Workflow: auto-merge-reviewed*
          STATUS_EOF

          gh pr comment "$PR_NUMBER" --body-file /tmp/status_comment.md || true

      - name: ðŸ“‹ Workflow Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ”„ Auto-Merge Status

          ## PR Information

          - **PR Number:** #${{ github.event.pull_request.number }}
          - **Title:** ${{ github.event.pull_request.title }}
          - **Branch:** `${{ github.event.pull_request.head.ref }}`

          ## Status Checks

          - **Draft:** ${{ steps.pr_status.outputs.is_draft }}
          - **Mergeable:** ${{ steps.pr_status.outputs.mergeable }}
          - **Review Decision:** ${{ steps.pr_status.outputs.review_decision }}
          - **Failed Checks:** ${{ steps.pr_status.outputs.failed_checks }}
          - **Pending Checks:** ${{ steps.pr_status.outputs.pending_checks }}
          - **Can Merge:** ${{ steps.pr_status.outputs.can_merge }}

          ## Actions Taken

          ${{ steps.pr_status.outputs.can_merge == 'true' && 'âœ… Auto-approval and auto-merge enabled' || 'â¸ï¸ Waiting for conditions to be met' }}

          ---
          *Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
