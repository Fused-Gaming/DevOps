name: Auto PR & Merge

on:
  push:
    branches:
      - "**"
      - "!main"
      - "!develop"

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 1: Create or Update PR
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  create-pr:
    name: üöÄ Create/Update Pull Request
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      pr_exists: ${{ steps.find-pr.outputs.exists }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check for existing PR
        id: find-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚Üí Checking for existing PR..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$PR_NUMBER" ]; then
            echo "‚úì Found existing PR #$PR_NUMBER"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "‚Üí No existing PR found"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: üìù Generate PR body
        id: pr-body
        if: steps.find-pr.outputs.exists == 'false'
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚Üí Generating PR description..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          # Get statistics
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= insertion)' || echo 0)
          LINES_DELETED=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= deletion)' || echo 0)

          # Get commits
          COMMITS=$(git log --pretty=format:"- %s (%h)" origin/main..HEAD)

          # Create PR body
          cat > /tmp/pr_body.md << 'EOFMARKER'
          ## ü§ñ Auto-Generated Pull Request

          **Branch:** `${{ github.ref_name }}`
          **Author:** @${{ github.actor }}
          **Triggered by:** Push to branch

          ### üìä Changes Summary

          - **Files changed:** FILES_CHANGED_PLACEHOLDER
          - **Lines added:** +LINES_ADDED_PLACEHOLDER
          - **Lines deleted:** -LINES_DELETED_PLACEHOLDER

          ### üìù Commits

          COMMITS_PLACEHOLDER

          ### ‚úÖ Auto-Merge Criteria

          This PR will be automatically merged if:
          - ‚úÖ All required checks pass (build, test, security)
          - ‚úÖ No merge conflicts detected
          - ‚úÖ Branch is up to date with main

          If checks fail or conflicts exist, the PR will be closed with a detailed report.

          ---
          *Auto-generated by workflow - Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          # Replace placeholders
          sed -i "s/FILES_CHANGED_PLACEHOLDER/$FILES_CHANGED/g" /tmp/pr_body.md
          sed -i "s/LINES_ADDED_PLACEHOLDER/$LINES_ADDED/g" /tmp/pr_body.md
          sed -i "s/LINES_DELETED_PLACEHOLDER/$LINES_DELETED/g" /tmp/pr_body.md
          sed -i "/COMMITS_PLACEHOLDER/c\\$COMMITS" /tmp/pr_body.md

          echo "‚úì PR body generated"

      - name: üöÄ Create Pull Request
        if: steps.find-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚Üí Creating Pull Request..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          gh pr create \
            --base main \
            --head "${{ github.ref_name }}" \
            --title "ü§ñ Auto: ${{ github.ref_name }}" \
            --body-file /tmp/pr_body.md \
            --label "auto-generated,automated-pr"

          # Get the PR number
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')
          echo "‚úì Created PR #$PR_NUMBER"

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 2: Wait for required checks
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  wait-for-checks:
    name: ‚è≥ Wait for Required Checks
    runs-on: ubuntu-latest
    needs: create-pr
    outputs:
      checks_passed: ${{ steps.check-status.outputs.passed }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚è≥ Wait for CI/CD checks
        id: check-status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚Üí Waiting for required checks..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          # Wait a bit for checks to start
          sleep 30

          # Check if PR exists
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "‚úó No PR found"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Wait for checks (max 10 minutes)
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "‚Üí Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Get check status (excluding this workflow)
            CHECK_STATUS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion 2>/dev/null || echo "[]")

            # Filter out this workflow
            FILTERED_CHECKS=$(echo "$CHECK_STATUS" | jq '[.[] | select(.name != "Auto PR & Merge")]')

            if [ "$(echo "$FILTERED_CHECKS" | jq '. | length')" -eq 0 ]; then
              echo "  No required checks found (or only auto-merge workflow)"
              echo "passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if all are completed
            PENDING=$(echo "$FILTERED_CHECKS" | jq '[.[] | select(.state == "PENDING" or .state == "IN_PROGRESS")] | length')

            if [ "$PENDING" -eq 0 ]; then
              # All checks completed, check if they passed
              FAILED=$(echo "$FILTERED_CHECKS" | jq '[.[] | select(.conclusion != "SUCCESS" and .conclusion != "SKIPPED")] | length')

              if [ "$FAILED" -eq 0 ]; then
                echo "‚úì All checks passed!"
                echo "passed=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "‚úó Some checks failed"
                echo "passed=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            echo "  Still waiting for checks to complete..."
            sleep 10
          done

          echo "‚ö†Ô∏è Timeout waiting for checks"
          echo "passed=false" >> $GITHUB_OUTPUT

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 3: Check for conflicts
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  check-conflicts:
    name: üîç Check Merge Conflicts
    runs-on: ubuntu-latest
    needs: create-pr
    outputs:
      has_conflicts: ${{ steps.check.outputs.has_conflicts }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Detect conflicts
        id: check
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚Üí Checking for merge conflicts..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          git fetch origin main
          git merge --no-commit --no-ff origin/main 2>&1 || MERGE_FAILED=true

          if [ "$MERGE_FAILED" == "true" ]; then
            CONFLICTS=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "")
            if [ -n "$CONFLICTS" ]; then
              echo "‚úó Merge conflicts detected:"
              echo "$CONFLICTS" | while read file; do echo "  - $file"; done
              echo "has_conflicts=true" >> $GITHUB_OUTPUT
            else
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
            fi
            git merge --abort 2>/dev/null || true
          else
            echo "‚úì No conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort
          fi

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 4: Merge or Close
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  merge-or-close:
    name: üéØ Merge or Close PR
    runs-on: ubuntu-latest
    needs: [create-pr, wait-for-checks, check-conflicts]
    if: always() && needs.create-pr.result == 'success'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üéØ Determine action
        id: action
        run: |
          CHECKS_PASSED="${{ needs.wait-for-checks.outputs.checks_passed }}"
          HAS_CONFLICTS="${{ needs.check-conflicts.outputs.has_conflicts }}"

          echo "Checks passed: $CHECKS_PASSED"
          echo "Has conflicts: $HAS_CONFLICTS"

          if [ "$HAS_CONFLICTS" == "true" ]; then
            echo "action=close_conflicts" >> $GITHUB_OUTPUT
          elif [ "$CHECKS_PASSED" == "false" ]; then
            echo "action=close_failed" >> $GITHUB_OUTPUT
          elif [ "$CHECKS_PASSED" == "true" ]; then
            echo "action=merge" >> $GITHUB_OUTPUT
          else
            echo "action=skip" >> $GITHUB_OUTPUT
          fi

      - name: ‚úÖ Merge PR
        if: steps.action.outputs.action == 'merge'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')

          gh pr comment "$PR_NUMBER" --body "## ‚úÖ Auto-Merge Approved

          All checks passed! Merging automatically.

          ---
          *Auto-merged by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

          gh pr merge "$PR_NUMBER" --squash --delete-branch --auto

          echo "‚úì PR #$PR_NUMBER merged"

      - name: ‚ùå Close PR (Failed Checks)
        if: steps.action.outputs.action == 'close_failed'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')

          gh pr comment "$PR_NUMBER" --body "## ‚ùå Auto-Merge Rejected

          Required checks failed. Please review the logs and fix the issues.

          **View workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          *Auto-closed by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

          gh pr close "$PR_NUMBER"

          echo "‚úó PR #$PR_NUMBER closed due to failed checks"

      - name: ‚ùå Close PR (Conflicts)
        if: steps.action.outputs.action == 'close_conflicts'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')

          gh pr comment "$PR_NUMBER" --body "## ‚ùå Auto-Merge Rejected - Conflicts

          This PR has merge conflicts with main. Please resolve them:

          \`\`\`bash
          git checkout ${{ github.ref_name }}
          git fetch origin main
          git merge origin/main
          # Resolve conflicts
          git commit
          git push
          \`\`\`

          ---
          *Auto-closed by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

          gh pr close "$PR_NUMBER"

          echo "‚úó PR #$PR_NUMBER closed due to conflicts"
