name: Auto PR & Merge

on:
  push:
    branches:
      - "**"
      - "!main"
      - "!develop"

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Create or Update PR
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  create-pr:
    name: ðŸš€ Create/Update Pull Request
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      pr_exists: ${{ steps.find-pr.outputs.exists }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for existing PR
        id: find-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Checking for existing PR..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$PR_NUMBER" ]; then
            echo "âœ“ Found existing PR #$PR_NUMBER"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "â†’ No existing PR found"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“ Generate PR body
        id: pr-body
        if: steps.find-pr.outputs.exists == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Generating PR description..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Get statistics
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= insertion)' || echo 0)
          LINES_DELETED=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= deletion)' || echo 0)

          # Get commits - save to temp file
          git log --pretty=format:"- %s (%h)" origin/main..HEAD > /tmp/commits.txt

          # Create PR body directly with variables
          cat > /tmp/pr_body.md << EOFMARKER
          ## ðŸ¤– Auto-Generated Pull Request

          **Branch:** \`${{ github.ref_name }}\`
          **Author:** @${{ github.actor }}
          **Triggered by:** Push to branch

          ### ðŸ“Š Changes Summary

          - **Files changed:** $FILES_CHANGED
          - **Lines added:** +$LINES_ADDED
          - **Lines deleted:** -$LINES_DELETED

          ### ðŸ“ Commits

          $(cat /tmp/commits.txt)

          ### âœ… Auto-Merge Criteria

          This PR will be automatically merged if:
          - âœ… All required checks pass (build, test, security)
          - âœ… No merge conflicts detected
          - âœ… Branch is up to date with main

          If checks fail or conflicts exist, the PR will be closed with a detailed report.

          ---
          *Auto-generated by workflow - Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          echo "âœ“ PR body generated"

      - name: ðŸ·ï¸ Ensure labels exist
        if: steps.find-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â†’ Ensuring required labels exist..."

          # Create labels if they don't exist
          gh label create "auto-generated" --description "Automatically generated by workflow" --color "0366d6" --force || true
          gh label create "automated-pr" --description "Pull request created automatically" --color "1d76db" --force || true

          echo "âœ“ Labels ready"

      - name: ðŸš€ Create Pull Request
        if: steps.find-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Creating Pull Request..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          gh pr create \
            --base main \
            --head "${{ github.ref_name }}" \
            --title "ðŸ¤– Auto: ${{ github.ref_name }}" \
            --body-file /tmp/pr_body.md \
            --label "auto-generated,automated-pr"

          # Get the PR number
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')
          echo "âœ“ Created PR #$PR_NUMBER"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Wait for required checks
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  wait-for-checks:
    name: â³ Wait for Required Checks
    runs-on: ubuntu-latest
    needs: create-pr
    outputs:
      checks_passed: ${{ steps.check-status.outputs.passed }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â³ Wait for CI/CD checks
        id: check-status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Waiting for required checks..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Wait a bit for checks to start
          sleep 30

          # Check if PR exists
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "âœ— No PR found"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Wait for checks (max 10 minutes)
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "â†’ Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Get check status (excluding this workflow)
            CHECK_STATUS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion 2>/dev/null || echo "[]")

            # Filter out this workflow
            FILTERED_CHECKS=$(echo "$CHECK_STATUS" | jq '[.[] | select(.name != "Auto PR & Merge")]')

            if [ "$(echo "$FILTERED_CHECKS" | jq '. | length')" -eq 0 ]; then
              echo "  No required checks found (or only auto-merge workflow)"
              echo "passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if all are completed
            PENDING=$(echo "$FILTERED_CHECKS" | jq '[.[] | select(.state == "PENDING" or .state == "IN_PROGRESS")] | length')

            if [ "$PENDING" -eq 0 ]; then
              # All checks completed, check if they passed
              FAILED=$(echo "$FILTERED_CHECKS" | jq '[.[] | select(.conclusion != "SUCCESS" and .conclusion != "SKIPPED")] | length')

              if [ "$FAILED" -eq 0 ]; then
                echo "âœ“ All checks passed!"
                echo "passed=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "âœ— Some checks failed"
                echo "passed=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            echo "  Still waiting for checks to complete..."
            sleep 10
          done

          echo "âš ï¸ Timeout waiting for checks"
          echo "passed=false" >> $GITHUB_OUTPUT

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Check for conflicts
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  check-conflicts:
    name: ðŸ” Check Merge Conflicts
    runs-on: ubuntu-latest
    needs: create-pr
    outputs:
      has_conflicts: ${{ steps.check.outputs.has_conflicts }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect conflicts
        id: check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Checking for merge conflicts..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          git fetch origin main
          git merge --no-commit --no-ff origin/main 2>&1 || MERGE_FAILED=true

          if [ "$MERGE_FAILED" == "true" ]; then
            CONFLICTS=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "")
            if [ -n "$CONFLICTS" ]; then
              echo "âœ— Merge conflicts detected:"
              echo "$CONFLICTS" | while read file; do echo "  - $file"; done
              echo "has_conflicts=true" >> $GITHUB_OUTPUT
            else
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
            fi
            git merge --abort 2>/dev/null || true
          else
            echo "âœ“ No conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: Merge or Close
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  merge-or-close:
    name: ðŸŽ¯ Merge or Close PR
    runs-on: ubuntu-latest
    needs: [create-pr, wait-for-checks, check-conflicts]
    if: always() && needs.create-pr.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Determine action
        id: action
        run: |
          CHECKS_PASSED="${{ needs.wait-for-checks.outputs.checks_passed }}"
          HAS_CONFLICTS="${{ needs.check-conflicts.outputs.has_conflicts }}"

          echo "Checks passed: $CHECKS_PASSED"
          echo "Has conflicts: $HAS_CONFLICTS"

          if [ "$HAS_CONFLICTS" == "true" ]; then
            echo "action=close_conflicts" >> $GITHUB_OUTPUT
          elif [ "$CHECKS_PASSED" == "false" ]; then
            echo "action=close_failed" >> $GITHUB_OUTPUT
          elif [ "$CHECKS_PASSED" == "true" ]; then
            echo "action=merge" >> $GITHUB_OUTPUT
          else
            echo "action=skip" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Collect check results
        id: checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found"
            exit 0
          fi

          # Get all checks
          CHECKS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion,detailsUrl 2>/dev/null || echo "[]")

          # Filter out this workflow
          FILTERED=$(echo "$CHECKS" | jq '[.[] | select(.name != "Auto PR & Merge")]')

          # Build check summary
          CHECK_SUMMARY=""
          if [ "$(echo "$FILTERED" | jq '. | length')" -gt 0 ]; then
            CHECK_SUMMARY=$(echo "$FILTERED" | jq -r '.[] |
              if .conclusion == "SUCCESS" then "- âœ… **\(.name)** - Passed"
              elif .conclusion == "FAILURE" then "- âŒ **\(.name)** - Failed"
              elif .conclusion == "SKIPPED" then "- â­ï¸ **\(.name)** - Skipped"
              else "- â³ **\(.name)** - \(.state)"
              end')
          else
            CHECK_SUMMARY="- â„¹ï¸ No additional checks required"
          fi

          # Save for next steps
          echo "$CHECK_SUMMARY" > /tmp/check_summary.txt

          TOTAL=$(echo "$FILTERED" | jq '. | length')
          PASSED=$(echo "$FILTERED" | jq '[.[] | select(.conclusion == "SUCCESS" or .conclusion == "SKIPPED")] | length')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT

      - name: âœ… Merge PR
        if: steps.action.outputs.action == 'merge'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')
          CHECK_SUMMARY=$(cat /tmp/check_summary.txt || echo "No checks found")

          cat > /tmp/merge_comment.md << EOFMARKER
          ## âœ… Auto-Merge Approved

          All required checks passed! Merging automatically.

          ### ðŸ“Š Check Summary

          $CHECK_SUMMARY

          ### ðŸ“ˆ Statistics

          - **Total Checks:** ${{ steps.checks.outputs.total }}
          - **Passed/Skipped:** ${{ steps.checks.outputs.passed }}
          - **Branch:** \`${{ github.ref_name }}\`
          - **Target:** \`main\`

          ---
          *Auto-merged by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          gh pr comment "$PR_NUMBER" --body-file /tmp/merge_comment.md
          gh pr merge "$PR_NUMBER" --squash --delete-branch --auto

          echo "âœ“ PR #$PR_NUMBER merged"

      - name: âŒ Close PR (Failed Checks)
        if: steps.action.outputs.action == 'close_failed'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')
          CHECK_SUMMARY=$(cat /tmp/check_summary.txt || echo "No check details available")

          # Get failed checks specifically
          CHECKS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion,detailsUrl 2>/dev/null || echo "[]")
          FAILED_CHECKS=$(echo "$CHECKS" | jq -r '[.[] | select(.conclusion == "FAILURE")] | .[] | "- âŒ [\(.name)](\(.detailsUrl)) - Failed"')

          cat > /tmp/close_comment.md << EOFMARKER
          ## âŒ Auto-Merge Rejected - Checks Failed

          One or more required checks failed. Please review the errors and fix them.

          ### âŒ Failed Checks

          $FAILED_CHECKS

          ### ðŸ“Š All Checks

          $CHECK_SUMMARY

          ### ðŸ”§ Next Steps

          1. Review the failed check logs above
          2. Fix the issues in your code
          3. Commit and push your changes
          4. The checks will run automatically

          ### ðŸ”— Links

          - [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [View All Checks](https://github.com/${{ github.repository }}/pull/$PR_NUMBER/checks)

          ---
          *Auto-closed by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          gh pr comment "$PR_NUMBER" --body-file /tmp/close_comment.md
          gh pr close "$PR_NUMBER"

          echo "âœ— PR #$PR_NUMBER closed due to failed checks"

      - name: âŒ Close PR (Conflicts)
        if: steps.action.outputs.action == 'close_conflicts'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --base main --json number -q '.[0].number')
          CHECK_SUMMARY=$(cat /tmp/check_summary.txt || echo "No check details available")

          cat > /tmp/conflict_comment.md << EOFMARKER
          ## âŒ Auto-Merge Rejected - Merge Conflicts

          This PR has merge conflicts with the main branch that must be resolved before merging.

          ### ðŸ”§ How to Resolve Conflicts

          1. **Update your branch:**
             \`\`\`bash
             git checkout ${{ github.ref_name }}
             git fetch origin main
             git merge origin/main
             \`\`\`

          2. **Resolve the conflicts:**
             - Open the conflicting files in your editor
             - Look for conflict markers (\`<<<<<<<\`, \`=======\`, \`>>>>>>>\`)
             - Manually resolve each conflict
             - Remove the conflict markers

          3. **Commit and push:**
             \`\`\`bash
             git add .
             git commit -m "fix: resolve merge conflicts with main"
             git push
             \`\`\`

          ### ðŸ“Š Check Status

          $CHECK_SUMMARY

          The PR will be automatically recreated when you push the resolved conflicts.

          ---
          *Auto-closed by workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          gh pr comment "$PR_NUMBER" --body-file /tmp/conflict_comment.md
          gh pr close "$PR_NUMBER"

          echo "âœ— PR #$PR_NUMBER closed due to conflicts"
