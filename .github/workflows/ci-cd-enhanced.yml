name: Enhanced CI/CD Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: "18.x"

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Security & Dependency Audit
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  security-audit:
    name: ðŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”’ Security & Dependency Audit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ“ Repository: ${{ github.repository }}"
          echo "âœ“ Branch: ${{ github.ref_name }}"
          echo "âœ“ Commit: ${{ github.sha }}"
          echo "âœ“ Author: ${{ github.actor }}"
          echo ""

      - name: ðŸ” Check for exposed secrets
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Scanning for exposed secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check if .env is tracked
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "âŒ CRITICAL: .env file is tracked in git!"
            exit 1
          else
            echo "âœ“ No .env file tracked in git"
          fi

          # Check for common secret patterns
          echo ""
          echo "â†’ Checking for common secret patterns..."
          if git grep -E "(api[_-]?key|secret|password|token|credentials).*=.*['\"][a-zA-Z0-9]{20,}" HEAD 2>/dev/null; then
            echo "âš ï¸  WARNING: Possible secrets detected!"
            echo "Please review the matches above"
          else
            echo "âœ“ No obvious secrets detected"
          fi

      - name: ðŸ“¦ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ” npm Audit
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running npm security audit..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          npm install --package-lock-only
          npm audit --json > audit-results.json || true

          # Parse and display results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)

          echo ""
          echo "Vulnerability Summary:"
          echo "  ðŸ”´ Critical: $CRITICAL"
          echo "  ðŸŸ  High:     $HIGH"
          echo "  ðŸŸ¡ Moderate: $MODERATE"
          echo "  ðŸŸ¢ Low:      $LOW"
          echo ""

          # Fail on critical or high vulnerabilities
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical or high vulnerabilities found!"
            echo "Run 'npm audit fix' to resolve"
            exit 1
          else
            echo "âœ“ No critical security vulnerabilities"
          fi

      - name: ðŸ“Š Generate Security Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”’ Security Audit Report

          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}

          ### Results

          - âœ… Secret scanning completed
          - âœ… Dependency audit completed

          ### Recommendations

          - Keep dependencies up to date
          - Review and rotate any exposed credentials
          - Enable branch protection rules
          - Use GitHub Dependabot for automated updates

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Build & Test
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”¨ Build & Test Pipeline"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ðŸ“¦ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "â†’ Installing dependencies..."
          npm ci
          echo "âœ“ Dependencies installed"

      - name: ðŸ§ª Run tests
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running test suite..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if grep -q '"test"' package.json; then
            npm test || echo "âš ï¸  No tests configured"
            echo "âœ“ Tests completed"
          else
            echo "âš ï¸  No test script found in package.json"
          fi

      - name: ðŸ—ï¸  Build project
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Building project..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if grep -q '"build"' package.json; then
            npm run build
            echo ""
            echo "âœ“ Build completed successfully"

            # Show build size
            if [ -d "dist" ]; then
              BUILD_SIZE=$(du -sh dist | cut -f1)
              echo "  Build size: $BUILD_SIZE"
            elif [ -d "build" ]; then
              BUILD_SIZE=$(du -sh build | cut -f1)
              echo "  Build size: $BUILD_SIZE"
            fi
          else
            echo "âš ï¸  No build script found in package.json"
          fi

      - name: ðŸ“Š Generate Build Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”¨ Build & Test Report

          **Status:** ${{ job.status }}
          **Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### Build Steps

          - âœ… Dependencies installed
          - âœ… Tests executed
          - âœ… Build completed

          ### Next Steps

          - Deploy to staging environment
          - Run integration tests
          - Review build artifacts

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Code Quality
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  code-quality:
    name: ðŸ“ Code Quality
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ Code Quality Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ðŸ“Š Lines of Code Changed
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "â†’ Analyzing PR changes..."
            git fetch origin ${{ github.base_ref }}

            LINES_ADDED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)' || echo 0)
            LINES_DELETED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletion)' || echo 0)
            FILES_CHANGED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | wc -l)

            echo ""
            echo "PR Statistics:"
            echo "  ðŸ“Š Files changed:   $FILES_CHANGED"
            echo "  âž• Lines added:     +$LINES_ADDED"
            echo "  âž– Lines deleted:   -$LINES_DELETED"
            echo "  ðŸ“ˆ Total changes:   $((LINES_ADDED + LINES_DELETED))"
            echo ""
          fi

      - name: ðŸ” Check for Debug Code
        run: |
          echo "â†’ Checking for debug code..."

          # Check for console.log, debugger, etc.
          if git grep -nE "(console\.log|debugger|TODO|FIXME)" HEAD -- '*.js' '*.ts' '*.jsx' '*.tsx' 2>/dev/null || true; then
            echo ""
            echo "âš ï¸  Found debug code or TODOs"
            echo "Consider cleaning these up before merging"
          else
            echo "âœ“ No debug code found"
          fi

      - name: ðŸ“Š Generate Quality Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“ Code Quality Report

          ### Analysis Complete

          - âœ… Debug code scan completed
          - âœ… Change statistics calculated

          ### Recommendations

          - Remove debug statements before merging
          - Address TODO/FIXME comments
          - Maintain consistent code style
          - Add tests for new functionality

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: Final Summary
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [security-audit, build-and-test, code-quality]
    if: always()
    steps:
      - name: ðŸ“Š Generate Final Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CI/CD Pipeline Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Job Results:"
          echo "  Security Audit:  ${{ needs.security-audit.result }}"
          echo "  Build & Test:    ${{ needs.build-and-test.result }}"
          echo "  Code Quality:    ${{ needs.code-quality.result }}"
          echo ""

          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ CI/CD Pipeline Summary

          ## Job Results

          | Job | Status |
          |-----|--------|
          | ðŸ”’ Security Audit | ${{ needs.security-audit.result }} |
          | ðŸ”¨ Build & Test | ${{ needs.build-and-test.result }} |
          | ðŸ“ Code Quality | ${{ needs.code-quality.result }} |

          ## Pipeline Information

          - **Repository:** ${{ github.repository }}
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** ${{ github.sha }}
          - **Author:** ${{ github.actor }}
          - **Triggered by:** ${{ github.event_name }}

          ## Next Steps

          - âœ… All checks passed - ready to merge
          - ðŸš€ Consider deploying to staging
          - ðŸ“ Update documentation if needed
          - ðŸ·ï¸  Tag a release when ready

          ---
          *Pipeline completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

      - name: âœ… Check Overall Status
        run: |
          if [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.build-and-test.result }}" != "success" ] || \
             [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "âŒ Pipeline failed - please review the errors above"
            exit 1
          else
            echo "âœ… All pipeline steps completed successfully!"
            echo ""
            echo "ðŸŽ‰ Ready for the next stage!"
          fi
