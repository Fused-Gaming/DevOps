name: Claude Usage Tracking & Test Feedback

# Author: User (via git config)
# Automatically track Claude Code usage and provide test feedback on every push/PR

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Prevent infinite loops - skip if commit is from bot
# This works in conjunction with [skip ci] in commit message

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Calculate and Track Claude Code Usage
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  track-usage:
    name: ðŸ“Š Track Claude Code Usage
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci] or is from usage tracking bot
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, 'chore: update Claude usage tracking')
    outputs:
      tokens_used: ${{ steps.calculate.outputs.tokens_used }}
      estimated_cost: ${{ steps.calculate.outputs.estimated_cost }}
      files_changed: ${{ steps.calculate.outputs.files_changed }}
      lines_changed: ${{ steps.calculate.outputs.lines_changed }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ¯ Initialize Tracking
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Claude Code Usage Tracking"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

      - name: ðŸ“Š Calculate Usage Metrics
        id: calculate
        run: |
          echo "â†’ Analyzing commit changes..."

          # Get base commit for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="HEAD~1"
          fi

          # Calculate changes
          FILES_CHANGED=$(git diff --numstat $BASE_REF HEAD | wc -l || echo 1)
          LINES_ADDED=$(git diff --numstat $BASE_REF HEAD | awk '{sum+=$1} END {print sum}' || echo 0)
          LINES_DELETED=$(git diff --numstat $BASE_REF HEAD | awk '{sum+=$2} END {print sum}' || echo 0)
          TOTAL_CHANGES=$((LINES_ADDED + LINES_DELETED))

          echo "Files changed: $FILES_CHANGED"
          echo "Lines added: +$LINES_ADDED"
          echo "Lines deleted: -$LINES_DELETED"
          echo "Total changes: $TOTAL_CHANGES"
          echo ""

          # Token estimation (1 line â‰ˆ 10-15 tokens, using 12 as average)
          # Add baseline for context and conversation
          ESTIMATED_TOKENS=$((TOTAL_CHANGES * 12 + 500))

          # Claude Sonnet 4.5 pricing (per million tokens)
          # Input: $3.00, Output: $15.00
          # Conservative estimate: 70% input, 30% output
          INPUT_TOKENS=$((ESTIMATED_TOKENS * 70 / 100))
          OUTPUT_TOKENS=$((ESTIMATED_TOKENS * 30 / 100))

          # Calculate cost in micro-dollars (to avoid floating point issues)
          # Input: $3.00 per million = 3000 micro-dollars per million = 0.003 per thousand
          # Output: $15.00 per million = 15000 micro-dollars per million = 0.015 per thousand
          INPUT_COST_MICRO=$((INPUT_TOKENS * 3000 / 1000000))
          OUTPUT_COST_MICRO=$((OUTPUT_TOKENS * 15000 / 1000000))
          TOTAL_COST_MICRO=$((INPUT_COST_MICRO + OUTPUT_COST_MICRO))

          # Convert to dollars with printf (no bc needed)
          ESTIMATED_COST=$(printf "%.4f" $(awk "BEGIN {print $TOTAL_COST_MICRO / 1000}"))

          echo "ðŸ’° Usage Estimate:"
          echo "  Estimated tokens: ~$ESTIMATED_TOKENS"
          echo "  Input tokens: ~$INPUT_TOKENS (70%)"
          echo "  Output tokens: ~$OUTPUT_TOKENS (30%)"
          echo "  Estimated cost: \$$ESTIMATED_COST"
          echo ""

          # Set outputs
          echo "tokens_used=$ESTIMATED_TOKENS" >> $GITHUB_OUTPUT
          echo "estimated_cost=$ESTIMATED_COST" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_changed=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

      - name: ðŸ“ Update CLAUDE_USAGE.md
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "â†’ Updating CLAUDE_USAGE.md..."

          # Run the tracking script
          if [ -f "scripts/track-claude-usage.sh" ]; then
            bash scripts/track-claude-usage.sh "${{ github.event.head_commit.message }}"
          else
            echo "âš ï¸  Warning: track-claude-usage.sh not found"
          fi

      - name: ðŸ’° Check Budget Alerts
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "â†’ Checking budget alerts..."

          if [ -f "scripts/budget-alerts.sh" ]; then
            bash scripts/budget-alerts.sh || true
          else
            echo "â„¹ï¸  Budget alerts script not found, skipping..."
          fi

      - name: ðŸ“Š Generate Feature Breakdown
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "â†’ Generating feature breakdown..."

          if [ -f "scripts/feature-breakdown.sh" ]; then
            bash scripts/feature-breakdown.sh || true
          else
            echo "â„¹ï¸  Feature breakdown script not found, skipping..."
          fi

      - name: ðŸŽ¯ Run Cost Optimization Analysis
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "â†’ Running cost optimization analysis..."

          if [ -f "scripts/cost-optimization.sh" ]; then
            bash scripts/cost-optimization.sh || true
          else
            echo "â„¹ï¸  Cost optimization script not found, skipping..."
          fi

      - name: ðŸ’¾ Commit Updated Usage File
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check for any changes in tracking files and reports
          CHANGES=$(git status --porcelain CLAUDE_USAGE.md reports/ logs/ || echo "")

          if [ -n "$CHANGES" ]; then
            TOKENS="${{ steps.calculate.outputs.tokens_used }}"
            COST="${{ steps.calculate.outputs.estimated_cost }}"

            # Add all tracking-related files
            git add CLAUDE_USAGE.md
            git add reports/ || true
            git add logs/ || true

            git commit -m "chore: update Claude usage tracking [skip ci]" -m "Auto-updated by workflow" -m "Tokens: $TOKENS" -m "Cost: \$$COST"

            # Push with retry logic (up to 4 retries with exponential backoff)
            MAX_RETRIES=4
            RETRY_COUNT=0
            DELAY=2

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin main; then
                echo "âœ“ CLAUDE_USAGE.md updated and committed"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying in ${DELAY}s... (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                  sleep $DELAY
                  DELAY=$((DELAY * 2))
                else
                  echo "âŒ Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "â„¹ï¸  No changes to CLAUDE_USAGE.md"
          fi

      - name: ðŸ“Š Generate Usage Report
        if: always()
        run: |
          # Get optimization score if available
          OPT_SCORE="N/A"
          if [ -f "reports/optimization-suggestions.md" ]; then
            OPT_SCORE=$(grep "Current Score:" "reports/optimization-suggestions.md" | grep -oP '\d+' | head -1 || echo "N/A")
          fi

          # Get total accumulated cost
          TOTAL_COST=$(grep "Total Estimated Cost" CLAUDE_USAGE.md | grep -oP '\d+\.\d+' || echo "0.00")
          TOTAL_SESSIONS=$(grep "Sessions:" CLAUDE_USAGE.md | grep -oP '\d+' || echo "0")

          cat > $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Claude Code Usage Report

          ## This Commit

          | Metric | Value |
          |--------|-------|
          | **Tokens Used** | ~${{ steps.calculate.outputs.tokens_used }} |
          | **Estimated Cost** | \$${{ steps.calculate.outputs.estimated_cost }} |
          | **Files Changed** | ${{ steps.calculate.outputs.files_changed }} |
          | **Lines Changed** | ${{ steps.calculate.outputs.lines_changed }} |

          ## Accumulated Totals

          | Metric | Value |
          |--------|-------|
          | **Total Sessions** | $TOTAL_SESSIONS |
          | **Total Cost** | \$$TOTAL_COST |
          | **Optimization Score** | $OPT_SCORE/100 |

          ## Budget Status

          Check the workflow logs for budget alerts and warnings.

          ## Pricing Reference

          **Claude Sonnet 4.5:**
          - Input tokens: \$3.00 per million tokens
          - Output tokens: \$15.00 per million tokens

          **Calculation:**
          - Estimated 70% input, 30% output tokens
          - ~12 tokens per line of code changed
          - +500 token baseline for context

          ## ðŸ“š Resources

          - View complete usage history: \`CLAUDE_USAGE.md\`
          - Feature breakdown: \`reports/feature-breakdown.md\`
          - Optimization suggestions: \`reports/optimization-suggestions.md\`
          - Budget alerts log: \`logs/budget-alerts.log\`

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Attribution: ${{ github.actor }}*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Run Tests with Detailed Feedback
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test-with-feedback:
    name: ðŸ§ª Run Tests with Troubleshooting
    runs-on: ubuntu-latest
    needs: track-usage

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Initialize Testing
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§ª Enhanced Test Suite with Diagnostics"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ðŸ“¦ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ” Environment Diagnostics
        run: |
          echo "â†’ System Information:"
          echo "  OS: $(uname -s)"
          echo "  Kernel: $(uname -r)"
          echo "  Architecture: $(uname -m)"
          echo ""

          echo "â†’ Available Tools:"
          echo "  Git: $(git --version || echo 'Not found')"
          echo "  Node: $(node --version 2>/dev/null || echo 'Not found')"
          echo "  npm: $(npm --version 2>/dev/null || echo 'Not found')"
          echo "  Python: $(python3 --version 2>/dev/null || echo 'Not found')"
          echo "  Docker: $(docker --version 2>/dev/null || echo 'Not found')"
          echo ""

      - name: ðŸ“¥ Install Dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25% Installing dependencies..."
          npm ci
          echo "âœ“ Dependencies installed"

      - name: ðŸ”’ Security Audit
        if: hashFiles('package.json') != ''
        continue-on-error: true
        run: |
          echo "[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 50% Running security audit..."

          npm audit --json > audit-results.json || true

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)

          echo ""
          echo "Security Scan Results:"
          echo "  ðŸ”´ Critical: $CRITICAL"
          echo "  ðŸŸ  High: $HIGH"
          echo "  ðŸŸ¡ Moderate: $MODERATE"
          echo "  ðŸŸ¢ Low: $LOW"
          echo ""

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸  Security vulnerabilities detected!"
            echo ""
            echo "ðŸ”§ Troubleshooting Steps:"
            echo "  1. Run: npm audit fix"
            echo "  2. For breaking changes: npm audit fix --force"
            echo "  3. Review: npm audit"
            echo "  4. Update manually if needed"
            echo ""
          fi

      - name: ðŸ§ª Run Tests
        if: hashFiles('package.json') != ''
        continue-on-error: true
        id: tests
        run: |
          echo "[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 75% Running tests..."

          if grep -q '"test"' package.json; then
            if npm test 2>&1 | tee test-output.log; then
              echo "âœ“ All tests passed"
              echo "test_status=passed" >> $GITHUB_OUTPUT
            else
              echo "âŒ Tests failed"
              echo "test_status=failed" >> $GITHUB_OUTPUT

              echo ""
              echo "ðŸ”§ Troubleshooting Test Failures:"
              echo ""
              echo "Common Issues & Solutions:"
              echo ""
              echo "1. Missing Dependencies"
              echo "   â†’ Run: npm install"
              echo "   â†’ Check package.json for all required packages"
              echo ""
              echo "2. Outdated Packages"
              echo "   â†’ Run: npm outdated"
              echo "   â†’ Update: npm update"
              echo ""
              echo "3. Environment Variables"
              echo "   â†’ Check .env.example for required vars"
              echo "   â†’ Set in GitHub Secrets if needed"
              echo ""
              echo "4. Database Connection"
              echo "   â†’ Verify database is running"
              echo "   â†’ Check connection string"
              echo "   â†’ Review migration status"
              echo ""
              echo "5. Port Conflicts"
              echo "   â†’ Check if ports are already in use"
              echo "   â†’ Use different ports in test config"
              echo ""
              echo "ðŸ“‹ Test Output (last 50 lines):"
              tail -50 test-output.log
              echo ""
            fi
          else
            echo "â„¹ï¸  No test script found"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ—ï¸  Build Check
        if: hashFiles('package.json') != ''
        continue-on-error: true
        id: build
        run: |
          echo "[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% Checking build..."

          if grep -q '"build"' package.json; then
            if npm run build 2>&1 | tee build-output.log; then
              echo "âœ“ Build successful"
              echo "build_status=passed" >> $GITHUB_OUTPUT

              # Show build size
              if [ -d "dist" ] || [ -d "build" ]; then
                BUILD_DIR=$([ -d "dist" ] && echo "dist" || echo "build")
                BUILD_SIZE=$(du -sh "$BUILD_DIR" | cut -f1)
                echo "  Build size: $BUILD_SIZE"
              fi
            else
              echo "âŒ Build failed"
              echo "build_status=failed" >> $GITHUB_OUTPUT

              echo ""
              echo "ðŸ”§ Troubleshooting Build Failures:"
              echo ""
              echo "Common Build Issues:"
              echo ""
              echo "1. TypeScript Errors"
              echo "   â†’ Run: npm run type-check (if available)"
              echo "   â†’ Check for type mismatches"
              echo "   â†’ Review tsconfig.json"
              echo ""
              echo "2. Missing Files"
              echo "   â†’ Check import paths"
              echo "   â†’ Verify all files are committed"
              echo "   â†’ Check .gitignore isn't excluding needed files"
              echo ""
              echo "3. Webpack/Vite Configuration"
              echo "   â†’ Review webpack.config.js or vite.config.js"
              echo "   â†’ Check for plugin compatibility"
              echo "   â†’ Verify loader configurations"
              echo ""
              echo "4. Memory Issues"
              echo "   â†’ Increase Node memory: NODE_OPTIONS=--max-old-space-size=4096"
              echo "   â†’ Check for circular dependencies"
              echo ""
              echo "5. Module Resolution"
              echo "   â†’ Clear node_modules and reinstall"
              echo "   â†’ Check package.json for correct versions"
              echo "   â†’ Verify peer dependencies"
              echo ""
              echo "ðŸ“‹ Build Output (last 50 lines):"
              tail -50 build-output.log
              echo ""
            fi
          else
            echo "â„¹ï¸  No build script found"
            echo "build_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Generate Test Report
        if: always()
        run: |
          TEST_STATUS="${{ steps.tests.outputs.test_status }}"
          BUILD_STATUS="${{ steps.build.outputs.build_status }}"

          cat > $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§ª Test & Build Report

          ## Status Summary

          | Check | Status |
          |-------|--------|
          | Tests | $([ "$TEST_STATUS" == "passed" ] && echo "âœ… Passed" || [ "$TEST_STATUS" == "failed" ] && echo "âŒ Failed" || echo "âš ï¸  Skipped") |
          | Build | $([ "$BUILD_STATUS" == "passed" ] && echo "âœ… Passed" || [ "$BUILD_STATUS" == "failed" ] && echo "âŒ Failed" || echo "âš ï¸  Skipped") |
          | Security | See security audit above |

          ## Troubleshooting Resources

          ### If Tests Failed:
          - Check test output above for specific errors
          - Verify all dependencies are installed
          - Check environment variables
          - Review database connections
          - Look for port conflicts

          ### If Build Failed:
          - Review build output for specific errors
          - Check TypeScript errors
          - Verify import paths
          - Check webpack/vite configuration
          - Clear node_modules and reinstall

          ### Common Commands:
          \`\`\`bash
          # Reinstall dependencies
          rm -rf node_modules package-lock.json
          npm install

          # Run tests locally
          npm test

          # Run build locally
          npm run build

          # Check for issues
          npm run lint
          npm audit
          \`\`\`

          ## Next Steps

          1. âœ… Fix any failing tests
          2. âœ… Resolve security vulnerabilities
          3. âœ… Ensure build succeeds
          4. âœ… Review code quality
          5. âœ… Update documentation

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Attribution: ${{ github.actor }}*
          EOF

      - name: ðŸ“¤ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-output.log
            build-output.log
            audit-results.json
          retention-days: 30

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Comment on PR with Usage & Test Summary
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  pr-comment:
    name: ðŸ’¬ PR Feedback
    runs-on: ubuntu-latest
    needs: [track-usage, test-with-feedback]
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tokensUsed = '${{ needs.track-usage.outputs.tokens_used }}';
            const estimatedCost = '${{ needs.track-usage.outputs.estimated_cost }}';
            const filesChanged = '${{ needs.track-usage.outputs.files_changed }}';
            const linesChanged = '${{ needs.track-usage.outputs.lines_changed }}';

            const comment = `## ðŸ“Š Claude Code Usage & Test Report

            ### ðŸ’° Usage Estimate for this PR

            | Metric | Value |
            |--------|-------|
            | **Estimated Tokens** | ~${tokensUsed} |
            | **Estimated Cost** | \$${estimatedCost} |
            | **Files Changed** | ${filesChanged} |
            | **Lines Changed** | ${linesChanged} |

            ### ðŸ“‹ Test Status

            - Tests: Check workflow for detailed results
            - Build: Check workflow for build status
            - Security: npm audit completed

            ### ðŸ’¡ Notes

            - Token estimation based on ~12 tokens per line changed
            - Uses Claude Sonnet 4.5 pricing (Input: $3/M, Output: $15/M)
            - Assumes 70% input / 30% output token distribution

            ### ðŸ”— Resources

            - [View Complete Usage History](../blob/main/CLAUDE_USAGE.md)
            - [Test Troubleshooting Guide](../blob/main/NEW-FEATURES-GUIDE.md#troubleshooting)

            ---
            *Auto-generated by Claude Usage Tracking workflow*
            *Attribution: ${{ github.actor }}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
