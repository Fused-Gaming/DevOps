name: Claude Usage Tracking & Test Feedback

# Author: User (via git config)
# Automatically track Claude Code usage and provide test feedback on every push/PR

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 1: Calculate and Track Claude Code Usage
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  track-usage:
    name: üìä Track Claude Code Usage
    runs-on: ubuntu-latest
    outputs:
      tokens_used: ${{ steps.calculate.outputs.tokens_used }}
      estimated_cost: ${{ steps.calculate.outputs.estimated_cost }}
      files_changed: ${{ steps.calculate.outputs.files_changed }}
      lines_changed: ${{ steps.calculate.outputs.lines_changed }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üéØ Initialize Tracking
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Claude Code Usage Tracking"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

      - name: üìä Calculate Usage Metrics
        id: calculate
        run: |
          echo "‚Üí Analyzing commit changes..."

          # Get base commit for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="HEAD~1"
          fi

          # Calculate changes
          FILES_CHANGED=$(git diff --numstat $BASE_REF HEAD | wc -l || echo 1)
          LINES_ADDED=$(git diff --numstat $BASE_REF HEAD | awk '{sum+=$1} END {print sum}' || echo 0)
          LINES_DELETED=$(git diff --numstat $BASE_REF HEAD | awk '{sum+=$2} END {print sum}' || echo 0)
          TOTAL_CHANGES=$((LINES_ADDED + LINES_DELETED))

          echo "Files changed: $FILES_CHANGED"
          echo "Lines added: +$LINES_ADDED"
          echo "Lines deleted: -$LINES_DELETED"
          echo "Total changes: $TOTAL_CHANGES"
          echo ""

          # Token estimation (1 line ‚âà 10-15 tokens, using 12 as average)
          # Add baseline for context and conversation
          ESTIMATED_TOKENS=$((TOTAL_CHANGES * 12 + 500))

          # Claude Sonnet 4.5 pricing (per million tokens)
          # Input: $3.00, Output: $15.00
          # Conservative estimate: 70% input, 30% output
          INPUT_TOKENS=$((ESTIMATED_TOKENS * 70 / 100))
          OUTPUT_TOKENS=$((ESTIMATED_TOKENS * 30 / 100))

          # Calculate cost in micro-dollars (to avoid floating point issues)
          # Input: $3.00 per million = 3000 micro-dollars per million = 0.003 per thousand
          # Output: $15.00 per million = 15000 micro-dollars per million = 0.015 per thousand
          INPUT_COST_MICRO=$((INPUT_TOKENS * 3000 / 1000000))
          OUTPUT_COST_MICRO=$((OUTPUT_TOKENS * 15000 / 1000000))
          TOTAL_COST_MICRO=$((INPUT_COST_MICRO + OUTPUT_COST_MICRO))

          # Convert to dollars with printf (no bc needed)
          ESTIMATED_COST=$(printf "%.4f" $(awk "BEGIN {print $TOTAL_COST_MICRO / 1000}"))

          echo "üí∞ Usage Estimate:"
          echo "  Estimated tokens: ~$ESTIMATED_TOKENS"
          echo "  Input tokens: ~$INPUT_TOKENS (70%)"
          echo "  Output tokens: ~$OUTPUT_TOKENS (30%)"
          echo "  Estimated cost: \$$ESTIMATED_COST"
          echo ""

          # Set outputs
          echo "tokens_used=$ESTIMATED_TOKENS" >> $GITHUB_OUTPUT
          echo "estimated_cost=$ESTIMATED_COST" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_changed=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

      - name: üìù Update CLAUDE_USAGE.md
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "‚Üí Updating CLAUDE_USAGE.md..."

          # Run the tracking script
          if [ -f "scripts/track-claude-usage.sh" ]; then
            bash scripts/track-claude-usage.sh "${{ github.event.head_commit.message }}"
          else
            echo "‚ö†Ô∏è  Warning: track-claude-usage.sh not found"
          fi

      - name: üíæ Commit Updated Usage File
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          if [ -n "$(git status --porcelain CLAUDE_USAGE.md)" ]; then
            git add CLAUDE_USAGE.md
            git commit -m "chore: update Claude usage tracking

Auto-updated by workflow
Tokens: ${{ steps.calculate.outputs.tokens_used }}
Cost: \$${{ steps.calculate.outputs.estimated_cost }}

Signed-off-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
            git push
            echo "‚úì CLAUDE_USAGE.md updated and committed"
          else
            echo "‚ÑπÔ∏è  No changes to CLAUDE_USAGE.md"
          fi

      - name: üìä Generate Usage Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << EOF
          # üìä Claude Code Usage Report

          ## This Commit

          | Metric | Value |
          |--------|-------|
          | **Tokens Used** | ~${{ steps.calculate.outputs.tokens_used }} |
          | **Estimated Cost** | \$${{ steps.calculate.outputs.estimated_cost }} |
          | **Files Changed** | ${{ steps.calculate.outputs.files_changed }} |
          | **Lines Changed** | ${{ steps.calculate.outputs.lines_changed }} |

          ## Pricing Reference

          **Claude Sonnet 4.5:**
          - Input tokens: \$3.00 per million tokens
          - Output tokens: \$15.00 per million tokens

          **Calculation:**
          - Estimated 70% input, 30% output tokens
          - ~12 tokens per line of code changed
          - +500 token baseline for context

          ## üí° Tip

          View complete usage history in \`CLAUDE_USAGE.md\`

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Attribution: ${{ github.actor }}*
          EOF

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 2: Run Tests with Detailed Feedback
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  test-with-feedback:
    name: üß™ Run Tests with Troubleshooting
    runs-on: ubuntu-latest
    needs: track-usage
    if: hashFiles('package.json') != '' || hashFiles('requirements.txt') != ''

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üéØ Initialize Testing
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üß™ Enhanced Test Suite with Diagnostics"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""

      - name: üì¶ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üîç Environment Diagnostics
        run: |
          echo "‚Üí System Information:"
          echo "  OS: $(uname -s)"
          echo "  Kernel: $(uname -r)"
          echo "  Architecture: $(uname -m)"
          echo ""

          echo "‚Üí Available Tools:"
          echo "  Git: $(git --version || echo 'Not found')"
          echo "  Node: $(node --version 2>/dev/null || echo 'Not found')"
          echo "  npm: $(npm --version 2>/dev/null || echo 'Not found')"
          echo "  Python: $(python3 --version 2>/dev/null || echo 'Not found')"
          echo "  Docker: $(docker --version 2>/dev/null || echo 'Not found')"
          echo ""

      - name: üì• Install Dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 25% Installing dependencies..."
          npm ci
          echo "‚úì Dependencies installed"

      - name: üîí Security Audit
        if: hashFiles('package.json') != ''
        continue-on-error: true
        run: |
          echo "[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 50% Running security audit..."

          npm audit --json > audit-results.json || true

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)

          echo ""
          echo "Security Scan Results:"
          echo "  üî¥ Critical: $CRITICAL"
          echo "  üü† High: $HIGH"
          echo "  üü° Moderate: $MODERATE"
          echo "  üü¢ Low: $LOW"
          echo ""

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ö†Ô∏è  Security vulnerabilities detected!"
            echo ""
            echo "üîß Troubleshooting Steps:"
            echo "  1. Run: npm audit fix"
            echo "  2. For breaking changes: npm audit fix --force"
            echo "  3. Review: npm audit"
            echo "  4. Update manually if needed"
            echo ""
          fi

      - name: üß™ Run Tests
        if: hashFiles('package.json') != ''
        continue-on-error: true
        id: tests
        run: |
          echo "[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 75% Running tests..."

          if grep -q '"test"' package.json; then
            if npm test 2>&1 | tee test-output.log; then
              echo "‚úì All tests passed"
              echo "test_status=passed" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Tests failed"
              echo "test_status=failed" >> $GITHUB_OUTPUT

              echo ""
              echo "üîß Troubleshooting Test Failures:"
              echo ""
              echo "Common Issues & Solutions:"
              echo ""
              echo "1. Missing Dependencies"
              echo "   ‚Üí Run: npm install"
              echo "   ‚Üí Check package.json for all required packages"
              echo ""
              echo "2. Outdated Packages"
              echo "   ‚Üí Run: npm outdated"
              echo "   ‚Üí Update: npm update"
              echo ""
              echo "3. Environment Variables"
              echo "   ‚Üí Check .env.example for required vars"
              echo "   ‚Üí Set in GitHub Secrets if needed"
              echo ""
              echo "4. Database Connection"
              echo "   ‚Üí Verify database is running"
              echo "   ‚Üí Check connection string"
              echo "   ‚Üí Review migration status"
              echo ""
              echo "5. Port Conflicts"
              echo "   ‚Üí Check if ports are already in use"
              echo "   ‚Üí Use different ports in test config"
              echo ""
              echo "üìã Test Output (last 50 lines):"
              tail -50 test-output.log
              echo ""
            fi
          else
            echo "‚ÑπÔ∏è  No test script found"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: üèóÔ∏è  Build Check
        if: hashFiles('package.json') != ''
        continue-on-error: true
        id: build
        run: |
          echo "[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100% Checking build..."

          if grep -q '"build"' package.json; then
            if npm run build 2>&1 | tee build-output.log; then
              echo "‚úì Build successful"
              echo "build_status=passed" >> $GITHUB_OUTPUT

              # Show build size
              if [ -d "dist" ] || [ -d "build" ]; then
                BUILD_DIR=$([ -d "dist" ] && echo "dist" || echo "build")
                BUILD_SIZE=$(du -sh "$BUILD_DIR" | cut -f1)
                echo "  Build size: $BUILD_SIZE"
              fi
            else
              echo "‚ùå Build failed"
              echo "build_status=failed" >> $GITHUB_OUTPUT

              echo ""
              echo "üîß Troubleshooting Build Failures:"
              echo ""
              echo "Common Build Issues:"
              echo ""
              echo "1. TypeScript Errors"
              echo "   ‚Üí Run: npm run type-check (if available)"
              echo "   ‚Üí Check for type mismatches"
              echo "   ‚Üí Review tsconfig.json"
              echo ""
              echo "2. Missing Files"
              echo "   ‚Üí Check import paths"
              echo "   ‚Üí Verify all files are committed"
              echo "   ‚Üí Check .gitignore isn't excluding needed files"
              echo ""
              echo "3. Webpack/Vite Configuration"
              echo "   ‚Üí Review webpack.config.js or vite.config.js"
              echo "   ‚Üí Check for plugin compatibility"
              echo "   ‚Üí Verify loader configurations"
              echo ""
              echo "4. Memory Issues"
              echo "   ‚Üí Increase Node memory: NODE_OPTIONS=--max-old-space-size=4096"
              echo "   ‚Üí Check for circular dependencies"
              echo ""
              echo "5. Module Resolution"
              echo "   ‚Üí Clear node_modules and reinstall"
              echo "   ‚Üí Check package.json for correct versions"
              echo "   ‚Üí Verify peer dependencies"
              echo ""
              echo "üìã Build Output (last 50 lines):"
              tail -50 build-output.log
              echo ""
            fi
          else
            echo "‚ÑπÔ∏è  No build script found"
            echo "build_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: üìä Generate Test Report
        if: always()
        run: |
          TEST_STATUS="${{ steps.tests.outputs.test_status }}"
          BUILD_STATUS="${{ steps.build.outputs.build_status }}"

          cat > $GITHUB_STEP_SUMMARY << EOF
          # üß™ Test & Build Report

          ## Status Summary

          | Check | Status |
          |-------|--------|
          | Tests | $([ "$TEST_STATUS" == "passed" ] && echo "‚úÖ Passed" || [ "$TEST_STATUS" == "failed" ] && echo "‚ùå Failed" || echo "‚ö†Ô∏è  Skipped") |
          | Build | $([ "$BUILD_STATUS" == "passed" ] && echo "‚úÖ Passed" || [ "$BUILD_STATUS" == "failed" ] && echo "‚ùå Failed" || echo "‚ö†Ô∏è  Skipped") |
          | Security | See security audit above |

          ## Troubleshooting Resources

          ### If Tests Failed:
          - Check test output above for specific errors
          - Verify all dependencies are installed
          - Check environment variables
          - Review database connections
          - Look for port conflicts

          ### If Build Failed:
          - Review build output for specific errors
          - Check TypeScript errors
          - Verify import paths
          - Check webpack/vite configuration
          - Clear node_modules and reinstall

          ### Common Commands:
          \`\`\`bash
          # Reinstall dependencies
          rm -rf node_modules package-lock.json
          npm install

          # Run tests locally
          npm test

          # Run build locally
          npm run build

          # Check for issues
          npm run lint
          npm audit
          \`\`\`

          ## Next Steps

          1. ‚úÖ Fix any failing tests
          2. ‚úÖ Resolve security vulnerabilities
          3. ‚úÖ Ensure build succeeds
          4. ‚úÖ Review code quality
          5. ‚úÖ Update documentation

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Attribution: ${{ github.actor }}*
          EOF

      - name: üì§ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-output.log
            build-output.log
            audit-results.json
          retention-days: 30

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # Job 3: Comment on PR with Usage & Test Summary
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  pr-comment:
    name: üí¨ PR Feedback
    runs-on: ubuntu-latest
    needs: [track-usage, test-with-feedback]
    if: github.event_name == 'pull_request'

    steps:
      - name: üí¨ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tokensUsed = '${{ needs.track-usage.outputs.tokens_used }}';
            const estimatedCost = '${{ needs.track-usage.outputs.estimated_cost }}';
            const filesChanged = '${{ needs.track-usage.outputs.files_changed }}';
            const linesChanged = '${{ needs.track-usage.outputs.lines_changed }}';

            const comment = `## üìä Claude Code Usage & Test Report

            ### üí∞ Usage Estimate for this PR

            | Metric | Value |
            |--------|-------|
            | **Estimated Tokens** | ~${tokensUsed} |
            | **Estimated Cost** | \$${estimatedCost} |
            | **Files Changed** | ${filesChanged} |
            | **Lines Changed** | ${linesChanged} |

            ### üìã Test Status

            - Tests: Check workflow for detailed results
            - Build: Check workflow for build status
            - Security: npm audit completed

            ### üí° Notes

            - Token estimation based on ~12 tokens per line changed
            - Uses Claude Sonnet 4.5 pricing (Input: $3/M, Output: $15/M)
            - Assumes 70% input / 30% output token distribution

            ### üîó Resources

            - [View Complete Usage History](../blob/main/CLAUDE_USAGE.md)
            - [Test Troubleshooting Guide](../blob/main/NEW-FEATURES-GUIDE.md#troubleshooting)

            ---
            *Auto-generated by Claude Usage Tracking workflow*
            *Attribution: ${{ github.actor }}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
