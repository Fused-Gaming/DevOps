name: Commit Message Linting

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  lint-commits:
    name: Lint Commit Messages
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Validate Commit Messages
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Commit Message Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Get commits in PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Valid commit types
          VALID_TYPES="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert"

          ERRORS=0
          WARNINGS=0

          # Check each commit
          while IFS= read -r commit; do
            SHA=$(echo "$commit" | awk '{print $1}')
            MSG=$(echo "$commit" | cut -d' ' -f2-)

            echo "Checking: $SHA"
            echo "Message: $MSG"

            # Check format: type: description
            if ! echo "$MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .+"; then
              echo "  âŒ FAIL: Invalid format"
              echo "     Expected: <type>: <description>"
              echo "     Valid types: $VALID_TYPES"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ“ PASS: Valid format"
            fi

            # Check length (max 72 chars for subject)
            SUBJECT=$(echo "$MSG" | head -1)
            LENGTH=${#SUBJECT}
            if [ $LENGTH -gt 72 ]; then
              echo "  âš  WARNING: Subject too long ($LENGTH > 72 chars)"
              WARNINGS=$((WARNINGS + 1))
            fi

            # Check capitalization (should not start with capital after type)
            if echo "$MSG" | grep -qE "^($VALID_TYPES): [A-Z]"; then
              echo "  âš  WARNING: Description should start with lowercase"
              WARNINGS=$((WARNINGS + 1))
            fi

            echo ""
          done < <(git log --oneline $BASE_SHA..$HEAD_SHA)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Results:"
          echo "  Errors: $ERRORS"
          echo "  Warnings: $WARNINGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Commit message validation failed!"
            echo ""
            echo "Commit Message Format:"
            echo "  <type>: <description>"
            echo ""
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix: resolve bug in component"
            echo "  docs: update README"
            echo ""
            exit 1
          fi

          if [ $WARNINGS -gt 0 ]; then
            echo ""
            echo "âš  Validation passed with warnings"
          else
            echo ""
            echo "âœ“ All commit messages are valid!"
          fi

      - name: ğŸ’¬ Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const codeBlock = '```';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Commit Message Validation Failed\n\nSome commits don't follow the required format.\n\n**Required Format:**\n${codeBlock}\n<type>: <description>\n${codeBlock}\n\n**Valid Types:**\n- \`feat\`: New feature\n- \`fix\`: Bug fix\n- \`docs\`: Documentation changes\n- \`style\`: Code style changes (formatting, etc.)\n- \`refactor\`: Code refactoring\n- \`perf\`: Performance improvements\n- \`test\`: Adding or updating tests\n- \`chore\`: Maintenance tasks\n- \`build\`: Build system changes\n- \`ci\`: CI/CD changes\n- \`revert\`: Revert previous commit\n\n**Examples:**\n${codeBlock}\nfeat: add user authentication\nfix: resolve null pointer exception\ndocs: update installation guide\n${codeBlock}\n\n**Tips:**\n- Start description with lowercase\n- Keep subject line under 72 characters\n- Use imperative mood ("add" not "added")\n\nUse our commit message generator:\n${codeBlock}bash\n./scripts/generate-commit-message.sh\n${codeBlock}\n\n---\n*Generated by commit-lint workflow*`
            });
