name: Commit Message Linting

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint-commits:
    name: Lint Commit Messages
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Validate Commit Messages
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Commit Message Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Get commits in PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Valid commit types
          VALID_TYPES="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert"

          ERRORS=0
          WARNINGS=0

          # Check if there are any commits to validate
          COMMIT_COUNT=$(git log --oneline $BASE_SHA..$HEAD_SHA 2>/dev/null | wc -l)
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "â„¹ï¸ No commits to validate"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ“ Validation complete (no commits)"
            exit 0
          fi

          echo "Found $COMMIT_COUNT commit(s) to validate"
          echo ""

          # Check each commit
          while IFS= read -r commit; do
            SHA=$(echo "$commit" | awk '{print $1}')
            MSG=$(echo "$commit" | cut -d' ' -f2-)

            echo "Checking: $SHA"
            echo "Message: $MSG"

            # Check format: type: description
            if ! echo "$MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .+"; then
              echo "  âŒ FAIL: Invalid format"
              echo "     Expected: <type>: <description>"
              echo "     Valid types: $VALID_TYPES"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ“ PASS: Valid format"
            fi

            # Check length (max 72 chars for subject)
            SUBJECT=$(echo "$MSG" | head -1)
            LENGTH=${#SUBJECT}
            if [ $LENGTH -gt 72 ]; then
              echo "  âš  WARNING: Subject too long ($LENGTH > 72 chars)"
              WARNINGS=$((WARNINGS + 1))
            fi

            # Check capitalization (should not start with capital after type)
            if echo "$MSG" | grep -qE "^($VALID_TYPES): [A-Z]"; then
              echo "  âš  WARNING: Description should start with lowercase"
              WARNINGS=$((WARNINGS + 1))
            fi

            echo ""
          done < <(git log --oneline $BASE_SHA..$HEAD_SHA)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Results:"
          echo "  Errors: $ERRORS"
          echo "  Warnings: $WARNINGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Commit message validation failed!"
            echo ""
            echo "Commit Message Format:"
            echo "  <type>: <description>"
            echo ""
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix: resolve bug in component"
            echo "  docs: update README"
            echo ""
            exit 1
          fi

          if [ $WARNINGS -gt 0 ]; then
            echo ""
            echo "âš  Validation passed with warnings"
          else
            echo ""
            echo "âœ“ All commit messages are valid!"
          fi

      - name: ğŸ’¬ Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Commit Message Validation Failed

Some commits don't follow the required format.

**Required Format:**
\`\`\`
<type>: <description>
\`\`\`

**Valid Types:**
- \`feat\`: New feature
- \`fix\`: Bug fix
- \`docs\`: Documentation changes
- \`style\`: Code style changes (formatting, etc.)
- \`refactor\`: Code refactoring
- \`perf\`: Performance improvements
- \`test\`: Adding or updating tests
- \`chore\`: Maintenance tasks
- \`build\`: Build system changes
- \`ci\`: CI/CD changes
- \`revert\`: Revert previous commit

**Examples:**
\`\`\`
feat: add user authentication
fix: resolve null pointer exception
docs: update installation guide
\`\`\`

**Tips:**
- Start description with lowercase
- Keep subject line under 72 characters
- Use imperative mood ("add" not "added")

Use our commit message generator:
\`\`\`bash
./scripts/generate-commit-message.sh
\`\`\`

---
*Generated by commit-lint workflow*`
            });
