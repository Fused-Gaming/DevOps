name: Feature Documentation Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: [main, develop]

jobs:
  feature-docs-validation:
    name: Validate Feature Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if feature branch
        id: check_branch
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ "$BRANCH" =~ ^(feature|feat)/ ]]; then
            echo "is_feature=true" >> $GITHUB_OUTPUT
            FEATURE_NAME="${BRANCH#*/}"
            echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
            echo "‚úì Feature branch detected: $BRANCH"
          else
            echo "is_feature=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Not a feature branch, skipping feature documentation check"
          fi

      - name: Determine feature size and enforcement tier
        if: steps.check_branch.outputs.is_feature == 'true'
        id: feature_size
        run: |
          # Calculate lines changed (additions + deletions)
          git fetch origin ${{ github.base_ref }}
          STATS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD)
          LINES_ADDED=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) insertion.*/\1/p')
          LINES_DELETED=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) deletion.*/\1/p')
          LINES_ADDED=${LINES_ADDED:-0}
          LINES_DELETED=${LINES_DELETED:-0}
          LINES_CHANGED=$((LINES_ADDED + LINES_DELETED))

          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT

          # Determine tier based on size
          # Tier 1: Small (<200 lines) - Documentation recommended but lenient
          # Tier 2: Medium (200-1000 lines) - Documentation required, all sections
          # Tier 3: Large (>1000 lines) - Comprehensive documentation required

          if [ $LINES_CHANGED -lt 200 ]; then
            echo "tier=1" >> $GITHUB_OUTPUT
            echo "tier_name=Small Feature" >> $GITHUB_OUTPUT
            echo "enforcement=lenient" >> $GITHUB_OUTPUT
            echo "üìè Feature size: $LINES_CHANGED lines (Tier 1: Small Feature)"
            echo "   Documentation recommended but not strictly enforced"
          elif [ $LINES_CHANGED -lt 1000 ]; then
            echo "tier=2" >> $GITHUB_OUTPUT
            echo "tier_name=Medium Feature" >> $GITHUB_OUTPUT
            echo "enforcement=standard" >> $GITHUB_OUTPUT
            echo "üìè Feature size: $LINES_CHANGED lines (Tier 2: Medium Feature)"
            echo "   Documentation required with all 4 sections"
          else
            echo "tier=3" >> $GITHUB_OUTPUT
            echo "tier_name=Large Feature" >> $GITHUB_OUTPUT
            echo "enforcement=strict" >> $GITHUB_OUTPUT
            echo "üìè Feature size: $LINES_CHANGED lines (Tier 3: Large Feature)"
            echo "   Comprehensive documentation required"
          fi

      - name: Check for feature documentation file
        if: steps.check_branch.outputs.is_feature == 'true'
        id: check_docs
        continue-on-error: ${{ steps.feature_size.outputs.tier == '1' }}
        run: |
          FEATURE_NAME="${{ steps.check_branch.outputs.feature_name }}"
          TIER="${{ steps.feature_size.outputs.tier }}"
          DOCS_PATHS=(
            "docs/features/${FEATURE_NAME}.md"
            "docs/features/${FEATURE_NAME}/README.md"
            ".devops/features/${FEATURE_NAME}.md"
            "FEATURES/${FEATURE_NAME}.md"
          )

          FOUND=false
          for path in "${DOCS_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "‚úì Feature documentation found at: $path"
              echo "docs_path=$path" >> $GITHUB_OUTPUT
              FOUND=true
              break
            fi
          done

          if [ "$FOUND" = false ]; then
            if [ "$TIER" = "1" ]; then
              echo "‚ö†Ô∏è Feature documentation not found (Tier 1: Recommended but not required)"
              echo "While not required for small features, documentation helps with context."
              echo ""
              echo "Consider creating brief documentation at: docs/features/${FEATURE_NAME}.md"
              exit 0
            else
              echo "‚ùå Feature documentation not found!"
              echo "Expected documentation at one of:"
              for path in "${DOCS_PATHS[@]}"; do
                echo "  - $path"
              done
              echo ""
              echo "Feature size: ${{ steps.feature_size.outputs.lines_changed }} lines (Tier $TIER)"
              echo "Documentation is REQUIRED for medium and large features."
              exit 1
            fi
          fi

      - name: Validate documentation content
        if: steps.check_branch.outputs.is_feature == 'true' && steps.check_docs.outputs.docs_path != ''
        continue-on-error: ${{ steps.feature_size.outputs.tier == '1' }}
        run: |
          DOCS_PATH="${{ steps.check_docs.outputs.docs_path }}"
          TIER="${{ steps.feature_size.outputs.tier }}"
          LINES_CHANGED="${{ steps.feature_size.outputs.lines_changed }}"

          echo "üìù Validating content of $DOCS_PATH"
          echo "   Feature tier: $TIER (${{ steps.feature_size.outputs.tier_name }})"
          echo "   Lines changed: $LINES_CHANGED"
          echo ""

          # Check minimum required sections
          REQUIRED_SECTIONS=(
            "## Overview"
            "## Goals"
            "## Implementation"
            "## Testing"
          )

          MISSING_SECTIONS=()
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "$section" "$DOCS_PATH"; then
              MISSING_SECTIONS+=("$section")
            fi
          done

          # Tier-based validation
          if [ ${#MISSING_SECTIONS[@]} -gt 0 ]; then
            echo "Missing sections:"
            for section in "${MISSING_SECTIONS[@]}"; do
              echo "  - $section"
            done
            echo ""

            if [ "$TIER" = "1" ]; then
              echo "‚ö†Ô∏è Tier 1 (Small Feature): Missing sections noted but not blocking"
              echo "   Recommended: Add missing sections for better context"
            elif [ "$TIER" = "2" ]; then
              echo "‚ùå Tier 2 (Medium Feature): All 4 sections REQUIRED"
              echo "   Please add the missing sections."
              echo "   See docs/templates/FEATURE_TEMPLATE.md for guidance."
              exit 1
            else
              echo "‚ùå Tier 3 (Large Feature): Comprehensive documentation REQUIRED"
              echo "   All sections must be present and detailed."
              echo "   See docs/templates/FEATURE_TEMPLATE.md for guidance."
              exit 1
            fi
          fi

          # Check minimum word count (tier-based requirements)
          WORD_COUNT=$(wc -w < "$DOCS_PATH")

          if [ "$TIER" = "1" ]; then
            MIN_WORDS=50
          elif [ "$TIER" = "2" ]; then
            MIN_WORDS=100
          else
            MIN_WORDS=200
          fi

          if [ "$WORD_COUNT" -lt "$MIN_WORDS" ]; then
            if [ "$TIER" = "1" ]; then
              echo "‚ö†Ô∏è Documentation word count: $WORD_COUNT (recommended: $MIN_WORDS+)"
              echo "   Consider adding more detail for better context"
            else
              echo "‚ùå Documentation is too brief: $WORD_COUNT words (minimum: $MIN_WORDS)"
              echo "   Please provide more detailed documentation"
              echo "   Tier $TIER features require comprehensive documentation"
              exit 1
            fi
          fi

          echo "‚úÖ Feature documentation validation passed!"
          echo "  - Required sections: ${#MISSING_SECTIONS[@]} missing (allowed for Tier $TIER)"
          echo "  - Word count: $WORD_COUNT words (minimum: $MIN_WORDS)"

      - name: Check if docs were updated in this PR
        if: steps.check_branch.outputs.is_feature == 'true' && steps.check_docs.outputs.docs_path != ''
        run: |
          DOCS_PATH="${{ steps.check_docs.outputs.docs_path }}"

          # Check if documentation was modified in this PR
          git fetch origin ${{ github.base_ref }}

          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "$DOCS_PATH"; then
            echo "‚úÖ Feature documentation was updated in this PR"
          else
            echo "‚ö†Ô∏è Warning: Feature documentation exists but wasn't updated in this PR"
            echo "If this feature branch includes new changes, please update the documentation."
          fi

      - name: Check for project goals alignment
        if: steps.check_branch.outputs.is_feature == 'true' && steps.check_docs.outputs.docs_path != ''
        run: |
          DOCS_PATH="${{ steps.check_docs.outputs.docs_path }}"

          # Check for alignment keywords
          ALIGNMENT_KEYWORDS=("project goal" "roadmap" "requirement" "objective" "guideline")

          FOUND_ALIGNMENT=false
          for keyword in "${ALIGNMENT_KEYWORDS[@]}"; do
            if grep -qi "$keyword" "$DOCS_PATH"; then
              FOUND_ALIGNMENT=true
              break
            fi
          done

          if [ "$FOUND_ALIGNMENT" = false ]; then
            echo "‚ö†Ô∏è Warning: Documentation should reference project goals/requirements"
            echo "Consider adding context about how this feature aligns with project objectives."
          else
            echo "‚úÖ Documentation references project alignment"
          fi

      - name: Generate documentation report
        if: always() && steps.check_branch.outputs.is_feature == 'true'
        run: |
          echo "## üìã Feature Documentation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature:** ${{ steps.check_branch.outputs.feature_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ steps.feature_size.outputs.lines_changed }} lines changed" >> $GITHUB_STEP_SUMMARY
          echo "**Tier:** ${{ steps.feature_size.outputs.tier_name }} (Tier ${{ steps.feature_size.outputs.tier }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tier explanation
          echo "### Enforcement Level" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.feature_size.outputs.tier }}" = "1" ]; then
            echo "üìù **Tier 1 (Small Feature):** Documentation recommended but not strictly enforced" >> $GITHUB_STEP_SUMMARY
            echo "- Minimum: 50 words" >> $GITHUB_STEP_SUMMARY
            echo "- Missing sections will show warnings but won't block merge" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.feature_size.outputs.tier }}" = "2" ]; then
            echo "üìã **Tier 2 (Medium Feature):** Documentation required with all 4 sections" >> $GITHUB_STEP_SUMMARY
            echo "- Minimum: 100 words" >> $GITHUB_STEP_SUMMARY
            echo "- All sections (Overview, Goals, Implementation, Testing) required" >> $GITHUB_STEP_SUMMARY
          else
            echo "üìö **Tier 3 (Large Feature):** Comprehensive documentation required" >> $GITHUB_STEP_SUMMARY
            echo "- Minimum: 200 words" >> $GITHUB_STEP_SUMMARY
            echo "- All sections must be detailed and thorough" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Documentation status
          echo "### Documentation Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_docs.outcome }}" = "success" ]; then
            echo "‚úÖ Feature documentation exists" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ Location: \`${{ steps.check_docs.outputs.docs_path }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Feature documentation missing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please create documentation at one of these locations:" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs/features/${{ steps.check_branch.outputs.feature_name }}.md\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs/features/${{ steps.check_branch.outputs.feature_name }}/README.md\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: failure() && steps.check_branch.outputs.is_feature == 'true' && steps.feature_size.outputs.tier != '1'
        uses: actions/github-script@v7
        with:
          script: |
            const featureName = '${{ steps.check_branch.outputs.feature_name }}';
            const tier = '${{ steps.feature_size.outputs.tier }}';
            const tierName = '${{ steps.feature_size.outputs.tier_name }}';
            const linesChanged = '${{ steps.feature_size.outputs.lines_changed }}';

            let tierRequirements = '';
            if (tier === '2') {
              tierRequirements = `**Tier 2 (Medium Feature):** ${linesChanged} lines changed
- Minimum: 100 words
- All 4 sections required (Overview, Goals, Implementation, Testing)
- Each section should be substantive`;
            } else {
              tierRequirements = `**Tier 3 (Large Feature):** ${linesChanged} lines changed
- Minimum: 200 words
- All 4 sections required with detailed content
- Comprehensive technical approach and testing documentation`;
            }

            const comment = `## ‚ö†Ô∏è Feature Documentation Required

This PR is for feature branch \`${{ github.head_ref }}\` but is missing proper feature documentation.

### Feature Size & Requirements

${tierRequirements}

### Why is this required?
Feature documentation helps:
- Keep the team aligned with project goals
- Prevent deviation from planned objectives
- Provide context for future maintenance
- Enable better code reviews

### What you need to do:

1. **Create a documentation file** at one of these locations:
   - \`docs/features/${featureName}.md\` (recommended)
   - \`docs/features/${featureName}/README.md\`
   - \`.devops/features/${featureName}.md\`

2. **Use the template:** Copy from \`docs/templates/FEATURE_TEMPLATE.md\`

3. **Include these required sections:**
   - **Overview**: What does this feature do? What problem does it solve?
   - **Goals**: How does it align with project objectives? Success criteria?
   - **Implementation**: Technical approach, key files, design decisions
   - **Testing**: Test strategy, coverage, edge cases

4. **Quick start:**
   \`\`\`bash
   cp docs/templates/FEATURE_TEMPLATE.md docs/features/${featureName}.md
   vim docs/features/${featureName}.md
   git add docs/features/${featureName}.md
   git commit -m "docs: add feature documentation"
   git push
   \`\`\`

5. **Validate:** Run \`devops-feature-validate\` (if using DevOps CLI)

The workflow will automatically re-check once you push the documentation.

### Resources
- **Quick Guide:** \`docs/FEATURE-DOCS-README.md\`
- **Full Guide:** \`docs/FEATURE-DOCUMENTATION-GUIDE.md\`
- **Template:** \`docs/templates/FEATURE_TEMPLATE.md\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    name: Documentation Check Summary
    runs-on: ubuntu-latest
    needs: feature-docs-validation
    if: always()
    steps:
      - name: Check result
        run: |
          if [ "${{ needs.feature-docs-validation.result }}" = "success" ]; then
            echo "‚úÖ All documentation checks passed!"
          else
            echo "‚ùå Documentation checks failed - please review requirements above"
            exit 1
          fi
