name: Workflow Summary Reporter

on:
  workflow_run:
    workflows:
      - "Enhanced CI/CD Pipeline"
      - "Auto PR & Merge"
      - "Commit Message Linting"
      - "Feature Docs Check"
      - "SEO & Marketing Automation"
    types:
      - completed

permissions:
  pull-requests: write
  actions: read
  checks: read
  contents: read

jobs:
  report-summary:
    runs-on: ubuntu-latest
    name: ðŸ“Š Generate Workflow Summary Report

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Get PR number
        id: get-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR associated with the workflow run
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Branch: $BRANCH"

          # Find PR for this branch
          PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found PR #$PR_NUMBER"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "â†’ No PR found for branch $BRANCH"
          fi

      - name: ðŸ“Š Collect workflow results
        id: collect
        if: steps.get-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Collecting workflow results for PR #$PR_NUMBER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Get all checks for the PR
          CHECKS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion,detailsUrl 2>/dev/null || echo "[]")

          # Count statuses
          TOTAL=$(echo "$CHECKS" | jq '. | length')
          PASSED=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "SUCCESS")] | length')
          FAILED=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "FAILURE")] | length')
          PENDING=$(echo "$CHECKS" | jq '[.[] | select(.state == "PENDING" or .state == "IN_PROGRESS")] | length')
          SKIPPED=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "SKIPPED")] | length')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "pending=$PENDING" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          # Save checks data
          echo "$CHECKS" > /tmp/checks.json

          echo "âœ“ Found $TOTAL checks: $PASSED passed, $FAILED failed, $PENDING pending, $SKIPPED skipped"

      - name: ðŸ“ Generate summary report
        id: report
        if: steps.get-pr.outputs.has_pr == 'true'
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_STATUS="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"

          TOTAL="${{ steps.collect.outputs.total }}"
          PASSED="${{ steps.collect.outputs.passed }}"
          FAILED="${{ steps.collect.outputs.failed }}"
          PENDING="${{ steps.collect.outputs.pending }}"
          SKIPPED="${{ steps.collect.outputs.skipped }}"

          # Determine overall status emoji
          if [ "$FAILED" -gt 0 ]; then
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Failed"
          elif [ "$PENDING" -gt 0 ]; then
            STATUS_EMOJI="â³"
            STATUS_TEXT="In Progress"
          elif [ "$PASSED" -gt 0 ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Passed"
          else
            STATUS_EMOJI="âšª"
            STATUS_TEXT="Pending"
          fi

          # Calculate percentage
          if [ "$TOTAL" -gt 0 ]; then
            PERCENTAGE=$(( (PASSED + SKIPPED) * 100 / TOTAL ))
          else
            PERCENTAGE=0
          fi

          # Generate progress bar
          PROGRESS_BLOCKS=$(( PERCENTAGE / 5 ))
          PROGRESS_BAR=$(printf 'â–ˆ%.0s' $(seq 1 $PROGRESS_BLOCKS))$(printf 'â–‘%.0s' $(seq 1 $((20 - PROGRESS_BLOCKS))))

          # Create detailed check list
          CHECKS_DETAIL=""
          if [ -f /tmp/checks.json ]; then
            CHECKS_DETAIL=$(jq -r '.[] |
              if .conclusion == "SUCCESS" then "- âœ… **\(.name)** - Passed"
              elif .conclusion == "FAILURE" then "- âŒ **\(.name)** - Failed ([View logs](\(.detailsUrl)))"
              elif .conclusion == "SKIPPED" then "- â­ï¸ **\(.name)** - Skipped"
              elif .state == "PENDING" or .state == "IN_PROGRESS" then "- â³ **\(.name)** - In Progress"
              else "- âšª **\(.name)** - \(.state)"
              end' /tmp/checks.json)
          fi

          # Build the report
          cat > /tmp/report.md << EOFMARKER
          ## $STATUS_EMOJI Workflow Summary: $WORKFLOW_NAME

          **Status:** $STATUS_TEXT | **Progress:** $PERCENTAGE% Complete

          \`\`\`
          $PROGRESS_BAR $PERCENTAGE%
          \`\`\`

          ### ðŸ“Š Check Results

          | Status | Count |
          |--------|-------|
          | âœ… Passed | $PASSED |
          | âŒ Failed | $FAILED |
          | â³ Pending | $PENDING |
          | â­ï¸ Skipped | $SKIPPED |
          | **Total** | **$TOTAL** |

          ### ðŸ“ Detailed Results

          $CHECKS_DETAIL

          ### ðŸ”— Links

          - [View Workflow Run]($WORKFLOW_URL)
          - [View All Checks](https://github.com/${{ github.repository }}/pull/${{ steps.get-pr.outputs.pr_number }}/checks)

          ---
          *Report generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC') by Workflow Summary Reporter*
          EOFMARKER

          echo "âœ“ Summary report generated"

      - name: ðŸ’¬ Post summary to PR
        if: steps.get-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Posting summary to PR #$PR_NUMBER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check if a comment already exists for this workflow
          EXISTING_COMMENT=$(gh pr view "$PR_NUMBER" --json comments --jq ".comments[] | select(.body | contains(\"Workflow Summary: $WORKFLOW_NAME\")) | .id" | head -1 || echo "")

          if [ -n "$EXISTING_COMMENT" ]; then
            # Try to update existing comment
            echo "â†’ Updating existing comment ID: $EXISTING_COMMENT"
            if gh api \
              -X PATCH \
              "/repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" \
              -f body="$(cat /tmp/report.md)" 2>/dev/null; then
              echo "âœ“ Comment updated"
            else
              # Comment doesn't exist anymore, create new one
              echo "âš ï¸ Comment not found (may have been deleted), creating new comment"
              gh pr comment "$PR_NUMBER" --body-file /tmp/report.md
              echo "âœ“ New comment posted"
            fi
          else
            # Create new comment
            echo "â†’ Creating new comment"
            gh pr comment "$PR_NUMBER" --body-file /tmp/report.md
            echo "âœ“ Comment posted"
          fi

      - name: ðŸ“Š Update workflow summary
        if: always()
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_STATUS="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          HAS_PR="${{ steps.get-pr.outputs.has_pr }}"
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"
          TOTAL="${{ steps.collect.outputs.total }}"
          PASSED="${{ steps.collect.outputs.passed }}"
          FAILED="${{ steps.collect.outputs.failed }}"
          PENDING="${{ steps.collect.outputs.pending }}"
          SKIPPED="${{ steps.collect.outputs.skipped }}"

          if [ "$HAS_PR" == "true" ]; then
            PR_INFO="#$PR_NUMBER"
            ACTION_TAKEN="âœ… Posted summary to PR"
          else
            PR_INFO="N/A"
            ACTION_TAKEN="âš ï¸ No PR found, skipping comment"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOFMARKER
          # ðŸ“Š Workflow Summary Report

          ## Workflow Information

          - **Name:** $WORKFLOW_NAME
          - **Status:** $WORKFLOW_STATUS
          - **Branch:** $BRANCH
          - **PR:** $PR_INFO

          ## Results

          - **Total Checks:** ${TOTAL:-0}
          - **Passed:** ${PASSED:-0}
          - **Failed:** ${FAILED:-0}
          - **Pending:** ${PENDING:-0}
          - **Skipped:** ${SKIPPED:-0}

          ## Actions Taken

          $ACTION_TAKEN

          [View Workflow Run]($WORKFLOW_URL)

          ---
          *Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOFMARKER

          echo "âœ“ Workflow summary updated"
